<!-- TODO 
	barre de vie pour perso ? non ! non ?
	les actif marche avec le parseur ouaaaa
	mettre les tooltip partout
	maitenant utiliser les stats des items
	rendre les choses plus jolie mdr

-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>taticus does it kill</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
	body, html {
		height: 100%;
		margin: 0;
	}
	.main-container {
		display: flex;
		flex-direction: column;
		height: 100%;
	}
	.content {
		flex: 1;
	}
	.top-buttons {
		flex: 0 0 auto;
		display: flex;
		justify-content: center;
		gap: 20px;		background: #f8f9fa;
		border-bottom: 1px solid #ccc;
	}
	.bottom-bar {
		position: absolute;
		left: 0;
		right: 0;
		bottom: 0;
		height: 40px;
		gap: 10px;
		background: #f8f9fa;
		border: 1px solid #ccc;
		display: flex;
		align-items: center;
		justify-content: flex-end;
	}
	.center-area {
		flex: 1 1 auto;
		position: relative;  
		background: #eee;
		/* background: url("img/background.jpg") no-repeat center center;
		background-size: cover; */
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.center-area h1 {
		color: #333;
	}
	.clickable-img {
		position: absolute;
		width: 120px;
		height: auto;
		cursor: pointer;
		transition: transform 0.2s;
		border-radius: 6px;
	}
	.clickable-img:hover {
		transform: scale(1.05);
	}
	.bottom-left {
		bottom: 80px;
		left: 135px;
	}
	.top-left {
		top: 20px;
		left: 20px;
	}
	.bottom-right {
		bottom: 20px;
		right: 20px;
	}
	.bottom-left-panel {
		bottom: 50px;
		left: 260px;
	}
	.bottom-left-menu-perso {
		display:none;
		position:absolute;
		bottom:270px;
		left:20px;
		background:white;
		border:1px solid #ccc;
		padding:5px;
		border-radius:5px;
	}
	.bottom-left-menu-palier {
		display:none; 
		position:absolute; 
		bottom:50px; 
		left:10px; 
		background:white; 
		border:1px solid #ccc; 
		padding:5px; 
		border-radius:5px;
	}
	.top-right-menu-perso {
		display:none;
		position:absolute;
		top:230px;
		right:20px;
		background:white;
		border:1px solid #ccc;
		padding:5px;
		border-radius:5px;
	}
	.top-right-menu-palier {
		display:none; 
		position:absolute; 
		top:10px; 
		right:10px; 
		background:white; 
		border:1px solid #ccc; 
		padding:5px; 
		border-radius:5px;
	}
	.top-right {
		top: 40px;
		right: 135px;
	}
	.top-right-panel {
		top: 10px;
		right: 260px;
	}
	/* Stats panel */
	.stats-panel {
		position: absolute;
		width: 280px;
		padding: 15px;
		background: rgb(255, 255, 255);
		border-left: 1px solid #ccc;
		box-shadow: -2px 0 6px rgba(0,0,0,0.1);
		display: none;
		border-radius: 6px;
	}
	.stats-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	.panel-icon {
		height: 30px;
	}
	.stats-line {
		margin: 5px 0;
		color: #000000;
		font-weight: bold;
	}
	.stats-images {
		margin-top: 15px;
	}
	.stat-with-number {
		display: flex;
		align-items: center;
		margin-bottom: 10px;
	}
	.stat-with-number img {
		width: 50px;
		margin-right: 10px;
	}
	.stat-number {
		font-size: 18px;
		font-weight: bold;
		color: #007bff;
	}
	.stats-images img {
		max-width: 50px;
		max-height: 50px;
		margin-right: 10px;
	}
	.buff-panel {
		position: absolute;
		width: 600px;
		padding: 15px;
		background: rgb(255, 255, 255);
		border-left: 1px solid #ccc;
		box-shadow: -2px 0 6px rgba(0,0,0,0.1);
		display: block;
		border-radius: 6px;
		max-height: 400px;
		overflow: scroll;
	}
	.buff-images {
		max-width: 50px;
		max-height: 50px;
		margin-right: 10px;
	}
	.stats-row {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
	}
	.greyed {
		filter: grayscale(100%);
	}
	.dropdown {
		border: 1px solid #ccc;
		border-radius: 5px;
		max-width: 200px;
		background: white;
	}
	.dropdown-item {
		padding: 5px;
		cursor: pointer;
	}
	.dropdown-item:hover {
		background: #f0f0f0;
	}
	.btn {
		display: flex;
		align-items: center;
		gap: 6px;
	}
	.btn-icon {
		width: 16px;
		height: 16px;
	}
	.custom-select {
		position: relative;
		
		width: 70px;
		cursor: pointer;
		user-select: none;
		font-family: sans-serif;
	
	}
	.custom-select .selected {
		padding: 5px;
		border: 1px solid #aaa;
		border-radius: 6px;
		background: #fff;
		display: flex;
		align-items: center;
		gap: 6px;
	}
	.custom-select .options {
		position: absolute;
		top: 0%;
		left: 0;
		right: 0;
		border: 1px solid #aaa;
		border-radius: 6px;
		background: #fff;
		box-shadow: 0 2px 6px rgba(0,0,0,0.15);
		z-index: 10;
		max-height: 200px;
		overflow-y: auto;
	}
	.custom-select .options div {
		padding: 5px 10px;
		display: flex;
		align-items: center;
		gap: 6px;
	}
	.custom-select .options div:hover {
		background: #eee;
	}
	.hidden {
		display: none;
	}
	/* Popup container */
	.battle-popup {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		background: #fff;
		border-radius: 12px;
		border: 1px solid #ddd;
		padding: 20px;
		z-index: 100;
		max-width: 420px;
		max-height: 100%;
		overflow-y: scroll;
		width: 90%;
		box-shadow: 0 8px 20px rgba(0,0,0,0.25);
		animation: fadeIn 0.3s ease-in-out;
	}
	/* Each round */
	.battle-round {
		margin-bottom: 15px;
		font-family: Arial, sans-serif;
	}
	.battle-round-title {
		font-weight: bold;
		margin-bottom: 5px;
	}
	/* Health bar */
	.hp-bar-container {
		width: 100%;
		height: 20px;
		background: #eee;
		border: 1px solid #ccc;
		border-radius: 8px;
		overflow: hidden;
		display: flex;
	}

	.hp-bar {
		height: 100%;
		transition: width 0.4s ease;
	}

	.green {
		background: linear-gradient(to right, #28a745, #218838); /* Green */
	}

	.yellow {
		background: linear-gradient(to right, #ffc107, #e0a800); /* Yellow */
	}

	.red {
		background: linear-gradient(to right, #ff4d4d, #cc0000); /* Red */
	}

	/* Close button */
	.battle-close-btn {
		display: block;
		margin: 10px auto 0;
		padding: 8px 16px;
		background: #007bff;
		color: white;
		border: none;
		border-radius: 6px;
		cursor: pointer;
		font-weight: bold;
		transition: background 0.3s ease;
	}
	.battle-close-btn:hover {
		background: #0056b3;
	}
	/* Fade animation */
	@keyframes fadeIn {
		from { opacity: 0; transform: translate(-50%, -45%); }
		to { opacity: 1; transform: translate(-50%, -50%); }
	}

</style>
</head>
<body>

<div class="main-container">
	
	<!-- Top Buttons -->
	<div class="top-buttons">
		<button class="btn btn-primary">Button 1</button>
		<button class="btn btn-success">Button 2</button>
		<button class="btn btn-danger">Button 3</button>
	</div>

	<!-- Center Area -->
	<div class="center-area">
		<h1></h1>

		<!-- buff panel on top left -->
		<div id="buffPanel" class="buff-panel top-left"></div>
		<div id="debuffPanel" class="buff-panel bottom-right"></div>

		<!-- Bottom-left image named 1 -->
		<img id="icon_1" src="img/perso/noperso/icon.png" alt="Left Image" class="clickable-img bottom-left"  onclick="showDropdown(1)" 
		data-bs-toggle="tooltip" 
		data-bs-placement="top" 
		title="">


		<!-- Menu déroulant selection perso (caché par défaut) -->
		<div id="dropdownMenu_perso_1" class="bottom-left-menu-perso">
		<select id="menuSelect_perso_1" onchange="showStats(1)">
			<option value="">-- Choisir un personnage --</option>
		</select>
		</div>

		<!-- Menu déroulant selection palier (caché par défaut) -->
		<div id="dropdownMenu_palier_1" class="bottom-left-menu-palier">
		<input type="hidden" id="palierValue_1">
		<div id="menuSelect_palier_1"></div>
		</div>

		<!-- Stats panel -->
		<div id="statsPanel_1" class="stats-panel bottom-left-panel">
			<div class="stats-row">
				<div class="stats-line" id="hp_id_1">0</div>
				<img id="palier_img_1" alt="icon" class="panel-icon">
			</div>
			<div class="stats-row">
				<div class="stats-line" id="armor_id_1">0</div>
				<div id="trait_container_1">
				</div>
			</div>
			<div class="stats-line" id="dmg_id_1">0</div>

			<!-- attack stats -->
			<div class="stats-images">
				<div class="stat-with-number">
					<img src="img/stat/mele.png" alt="mele" style="height:30px; width:30px; vertical-align:middle;">
					<img id="attack_mele_img_1" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="Small 1">
					<span id="attack_mele_nbr_1" class="stat-number">0</span>
				</div>
				<div class="stat-with-number" id ="attack_range_div_1">
					<img src="img/stat/range.png" alt="range" style="height:30px; width:30px; vertical-align:middle;">
					<img id="attack_range_img_1" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="Small 1">
					<span id="attack_range_nbr_1" class="stat-number">0</span>
				</div>
				<div class="stat-with-number">
					<img id="active_img_1" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="active">
					<img id="passive_img_1" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="passive">
				</div>
				<div class="stats-row">
					<!-- items select -->
					<div class="custom-select" id="item_1_select_1">
						<div class="selected">
							<img src="img/item/crit_empty.png" >
						</div>
						<div id="item_1_id_1" class="options hidden" data-type="notype">
						</div>
					</div>
					<div class="custom-select" id="item_2_select_1" data-type="notype">
						<div class="selected">
							<img src="img/item/defensive_empty.png" >
						</div>
						<div id="item_2_id_1" class="options hidden"></div>
					</div>
					<div class="custom-select" id="item_3_select_1" data-type="notype">
						<div class="selected">
							<img src="img/item/crit_boost_empty.png" >
						</div>
						<div id="item_3_id_1" class="options hidden"></div>
					</div>
				</div>
				<div class="stats-row">
					<input class="stats-line" type="number" style="width: 70px;" id="item_1_stat_1_id_1"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_2_stat_1_id_1"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_3_stat_1_id_1"></input>
				</div>
				<div class="stats-row">
					<input class="stats-line" type="number" style="width: 70px;" id="item_1_stat_2_id_1"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_2_stat_2_id_1"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_3_stat_2_id_1"></input>
				</div>
			</div>
		</div>




		<!-- Top-right image named 2 -->
		<img id="icon_2" src="img/perso/noperso/icon.png" alt="right Image" class="clickable-img top-right" onclick="showDropdown(2)">

		<!-- Menu déroulant selection perso 2 -->
		<div id="dropdownMenu_perso_2" class="top-right-menu-perso">
		<select id="menuSelect_perso_2" onchange="showStats(2)">
			<option value="">-- Choisir un personnage --</option>
		</select>
		</div>

		<!-- Menu déroulant selection palier (caché par défaut) -->
		<div id="dropdownMenu_palier_2" class="top-right-menu-palier">
		<input type="hidden" id="palierValue_2">
		<div id="menuSelect_palier_2"></div>
		</div>

		<!-- Stats panel -->
		<div id="statsPanel_2" class="stats-panel top-right-panel">
			<div class="stats-row">
				<div class="stats-line" id="hp_id_2">0</div>
				<img id="palier_img_2" alt="icon" class="panel-icon">
			</div>
			<div class="stats-row">
				<div class="stats-line" id="armor_id_2">0</div>
				<div id="trait_container_2">
				</div>
			</div>
			<div class="stats-line" id="dmg_id_2">0</div>

			<!-- attack stats -->
			<div class="stats-images">
				<div class="stat-with-number">
					<img src="img/stat/mele.png" alt="mele" style="height:30px; width:30px; vertical-align:middle;">
					<img id="attack_mele_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title=""  alt="Small 1">
					<span id="attack_mele_nbr_2" class="stat-number">0</span>
				</div>
				<div class="stat-with-number" id ="attack_range_div_2">
					<img src="img/stat/range.png" alt="range" style="height:30px; width:30px; vertical-align:middle;">
					<img id="attack_range_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="Small 1">
					<span id="attack_range_nbr_2" class="stat-number">0</span>
				</div>
				<div>
					<img id="active_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="active">
					<img id="passive_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="passive">
				</div>
				<div class="stats-row">
					<!-- items select -->
					<div class="custom-select" id="item_1_select_2">
						<div class="selected">
							<img src="img/item/crit_empty.png" >
						</div>
						<div id="item_1_id_2" class="options hidden" data-type="notype">
						</div>
					</div>
					<div class="custom-select" id="item_2_select_2" data-type="notype">
						<div class="selected">
							<img src="img/item/defensive_empty.png" >
						</div>
						<div id="item_2_id_2" class="options hidden"></div>
					</div>
					<div class="custom-select" id="item_3_select_2" data-type="notype">
						<div class="selected">
							<img src="img/item/crit_boost_empty.png" >
						</div>
						<div id="item_3_id_2" class="options hidden"></div>
					</div>
				</div>
				<div class="stats-row">
					<input class="stats-line" type="number" style="width: 70px;" id="item_1_stat_1_id_2"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_2_stat_1_id_2"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_3_stat_1_id_2"></input>
				</div>
				<div class="stats-row">
					<input class="stats-line" type="number" style="width: 70px;" id="item_1_stat_2_id_2"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_2_stat_2_id_2"></input>
					<input class="stats-line" type="number" style="width: 70px;" id="item_3_stat_2_id_2"></input>
				</div>
			</div>
		</div>
	
		<div class="bottom-bar">
			<!-- fill so button are on the right -->
			<button class="btn btn-primary" onclick=calcule_dmg(1)>
				<img src="img/stat/mele.png" alt="" class="btn-icon" > attack
			</button>
			<button class="btn btn-success" id="btn_range"  onclick=calcule_dmg(2)>
				<img  src="img/stat/range.png" alt="" class="btn-icon"> attack
			</button>
			<button class="btn btn-danger"  onclick=calcule_dmg(3)>
				<img id="btn_active_id" alt="" class="btn-icon"> active
			</button>
		</div>
	</div>
</div>

<script>

	async function loadMenuOptions(img_id) {
		// menu perso
		let response_perso = await fetch("mysqli/get_perso.php");
		let perso = await response_perso.json();

		let select_perso = document.getElementById("menuSelect_perso_"+img_id);
		select_perso.innerHTML = '<option value="">-- Choisir un personnage --</option>';

		perso.forEach(c => {
			let option = document.createElement("option");
			option.value = c.nom;
			option.textContent = c.prettyname;
			select_perso.appendChild(option);
		});

		// menu palier
		let response_palier = await fetch("mysqli/get_palier.php");
		let palier = await response_palier.json();

		let select_palier = document.getElementById("menuSelect_palier_"+img_id);
		select_palier.innerHTML = '';

		palier.forEach(c => {
			let item = document.createElement("div");
			item.classList.add("dropdown-item");
			item.innerHTML = `<img src="img/palier/${c.palier}.png" style="height:16px; margin-right:5px;"> ${c.palier}`;
			
			item.onclick = () => {
				// console.log("Selected:", c.palier);
				document.getElementById("palierValue_"+img_id).value  = c.palier;
				showStats(img_id);
			};

			select_palier.appendChild(item);
		});
	}

	async function showbuffstart() {// peut etre lancer ca que apres que on a le perso et le palier a voir??
		let response = await fetch("mysqli/get_buff.php");
		let data = await response.json();
		const buff_container = document.getElementById("buffPanel");
		const debuff_container = document.getElementById("debuffPanel");
		buff_container.innerHTML = '<div class="buff-images">';
		debuff_container.innerHTML = '<div class="buff-images">';
		let buff_length_row = 0;
		let debuff_length_row = 0;
		for (const buff of data) {
			if(buff.type == 'buff'){
				if(buff_length_row == 0){
					buff_container.innerHTML +='<div class="stat-with-number">';
				}
				buff_container.innerHTML +='<img id="buff_img_'+buff.id+'" data-selected="0" class="greyed buff-images" data-bs-toggle="tooltip" data-bs-placement="top" title="'+buff.prettyname+' : '+buff.description+'" alt="'+buff.nom+'" src="img/'+buff.locate+'.png" onclick="selectbuff('+buff.id+')" style="cursor:pointer;">';
				buff_length_row++;
				if(buff_length_row > 10){
					buff_container.innerHTML +='</div>';
					buff_length_row = 0;
				}
			}
			else if(buff.type == 'debuff'){
				
				if(debuff_length_row == 0){
					debuff_container.innerHTML +='<div class="stat-with-number">';
				}
				debuff_container.innerHTML +='<img id="buff_img_'+buff.id+'" data-selected="0" class="greyed buff-images" data-bs-toggle="tooltip" data-bs-placement="top" title="'+buff.prettyname+' : '+buff.description+'" alt="'+buff.nom+'" src="img/'+buff.locate+'.png" onclick="selectbuff('+buff.id+')" style="cursor:pointer;">';
				debuff_length_row++;
				if(debuff_length_row > 10){
					debuff_container.innerHTML +='</div>';
					debuff_length_row = 0;
				}
			}
		}
		buff_container.innerHTML +='</div>';
		const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
		const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
	}

	function getSelectedBuffs() {
		const selected = [];
		const buff_imgs = document.querySelectorAll("#buffPanel img");
		buff_imgs.forEach(img => {
			if (img.getAttribute("data-selected") === "1") {
				const buff_id = img.id.replace("buff_img_", "");
				selected.push(buff_id);
			}
		});
		return selected;
	}

	function showDropdown(img_id) {
		document.getElementById("dropdownMenu_perso_"+img_id).style.display = "none";
		document.getElementById("dropdownMenu_perso_"+img_id).style.display = "block";

		document.getElementById("dropdownMenu_palier_"+img_id).style.display = "none";
		document.getElementById("dropdownMenu_palier_"+img_id).style.display = "block";
	}

	async function showStats(img_id) {
		const perso_nom = document.getElementById("menuSelect_perso_"+img_id).value;
		const palier_nom = document.getElementById("palierValue_"+img_id).value;

		if (perso_nom && palier_nom) {

			let response = await fetch("mysqli/get_perso_stat.php?nom=" + perso_nom+"&palier=" + palier_nom);
			let data = await response.json();


			// afficher le panel et cacher les dropdowns
			document.getElementById("statsPanel_"+img_id).style.display = "block";

			// images
			// icon
			document.getElementById("icon_"+img_id).src = "img/perso/" + data.nom + "/icon.png";
			// active et passive
			document.getElementById("active_img_"+img_id).src = "img/perso/" + data.nom + "/active.png";
			document.getElementById("passive_img_"+img_id).src = "img/perso/" + data.nom + "/passive.png";
			document.getElementById("active_img_"+img_id).title = data.active_description;
			document.getElementById("passive_img_"+img_id).title = data.passive_description;
			// attaques
			// si nbr_hit_range = 0 alors on n'affiche pas l'attaque
			if(data.nbr_hit_range != 0){
				document.getElementById("attack_range_div_"+img_id).style.display = "block";
				document.getElementById("attack_range_img_"+img_id).src = "img/perfo/" + data.perfo_range + ".png";
				document.getElementById("attack_range_img_"+img_id).title = data.perfo_range_description;
				document.getElementById("attack_range_nbr_"+img_id).innerText = data.nbr_hit_range;
				if(img_id == 1){
					document.getElementById("btn_range").disabled = false;
				}
			}
			else{
				if(img_id == 1){
					document.getElementById("btn_range").disabled = true;
				}
				
				document.getElementById("attack_range_div_"+img_id).style.display = "none";
			}
			document.getElementById("attack_mele_img_"+img_id).src = "img/perfo/" + data.perfo_mele + ".png";
			document.getElementById("attack_mele_img_"+img_id).title = data.perfo_mele_description;
			document.getElementById("attack_mele_nbr_"+img_id).innerText = data.nbr_hit_mele;

			document.getElementById("palier_img_"+img_id).src = "img/palier/" + palier_nom + ".png";

			//img active btn 
			if(img_id == 1)
			{
				document.getElementById("btn_active_id").src = "img/perso/" + data.nom + "/active.png";
			}

			// stats
			document.getElementById("hp_id_"+img_id).innerHTML = '<img src="img/stat/hp_noir.png" alt="hp" style="height:20px; vertical-align:middle;"> '+
			`<input type="number" id="hp_input_${img_id}" value="${data.hp}" style="width:70px;">`;
			document.getElementById("armor_id_"+img_id).innerHTML = '<img src="img/stat/armor_noir.png" alt="armor" style="height:20px; vertical-align:middle;"> '+ 
			`<input type="number" id="armor_input_${img_id}" value="${data.armor}" style="width:70px;">`;
			document.getElementById("dmg_id_"+img_id).innerHTML = '<img src="img/stat/dmg_noir.png" alt="dmg" style="height:20px; vertical-align:middle;"> '+ 
			`<input type="number" id="dmg_input_${img_id}" value="${data.dmg}" style="width:70px;">`;


			// afficher traits
			const trait_container = document.getElementById("trait_container_"+img_id);
			trait_container.innerHTML = ''; // clear previous traits
			let traitsArray = JSON.parse(data.traits);
			for (const nom_trait of traitsArray) {
				let response_trait = await fetch("mysqli/get_trait_description.php?trait=" + nom_trait);
				let data_trait = await response_trait.json();
				trait_container.innerHTML += `<img src="img/trait/${nom_trait}.png" alt="${nom_trait}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="${data_trait.description}" style="height:20px; margin-right:5px;">`;
			}

			//afficher items
			// data.item1 data.item2 data.item3
			for (let index = 1; index <= 3; index++) {
				let response_item = await fetch("mysqli/get_item_stat.php?nom=" + perso_nom+"&palier=" + palier_nom +"&item_nbr=item"+index);
				let data_item = await response_item.json();
				const item_stat_1 = document.getElementById("item_"+index+"_stat_1_id_"+img_id);
				const item_stat_2 = document.getElementById("item_"+index+"_stat_2_id_"+img_id);

				const item_container = document.getElementById("item_"+index+"_id_"+img_id);
				item_container.innerHTML = '<div data-type="notype" data-value="empty" data-stat_1="0" data-stat_2="0"><img src="img/item/'+data[`item${index}`]+'_empty.png" data-bs-toggle="tooltip" data-bs-placement="right" title="no Item" ></div>';
				data_item.forEach(c => {
					item_container.innerHTML += `<div data-type="${c.type}" data-value="${c.nom}" data-stat_1="${c.stat_1}" data-stat_2="${c.stat_2}"><img src="img/item/${c.nom}.png" data-bs-toggle="tooltip" data-bs-placement="right" title="${c.prettyname}""></div>`;
				});
				item_container.querySelectorAll("div").forEach(option => {
					option.addEventListener("click", () => {
						const selected = document.querySelector(`#item_${index}_select_${img_id} .selected`);
						item_stat_1.value = option.dataset.stat_1;
						item_stat_2.value = option.dataset.stat_2;
						item_container.dataset.type = option.dataset.type;
						selected.innerHTML = option.innerHTML;
						selected.dataset.value = option.dataset.value;
						item_container.classList.add("hidden");
					});
				});
				const emptyOption = item_container.querySelector('div[data-value="empty"]');
				emptyOption.click();
			}

		}
		const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
		const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
	}

	async function calcule_dmg(attack_type) {
		// attack_type: 1 = mele, 2 = range, 3 = active
		const perso_attackant = document.getElementById("menuSelect_perso_1").value;
		const dmg_attackant = document.getElementById("dmg_input_1").value;
		const perso_defenceur = document.getElementById("menuSelect_perso_2").value;
		const hp_defenceur = document.getElementById("hp_input_2").value; // for now 1 always attack and 2 always defence (tochange later)
		const armor_defenceur = document.getElementById("armor_input_2").value
		const buffs = getSelectedBuffs();
		jsonBuffs = JSON.stringify(buffs);
		const encodedBuffs = encodeURIComponent(jsonBuffs);
		// need to have perso and dmg attackant and perso,hp,armor defenceur
		if (!perso_attackant || !perso_defenceur) {
			alert("Please select a character and tier first.");
			return;
		}

		let items = {};
		// here get item info we need item type stat1 and stat2 for 1,2,3 for perso 1 and 2,3 for perso 2  item_2_stat_1_id_1 
		for (let i = 1; i <= 3; i++) {
			const item_stat_1 = document.getElementById("item_"+i+"_stat_1_id_1").value;
			const item_stat_2 = document.getElementById("item_"+i+"_stat_2_id_1").value;
			const item_selected = document.getElementById("item_"+i+"_id_1").dataset.type;
			items[`item_id_${i}`] = [item_selected, item_stat_1, item_stat_2];
		}
		const jsonData1 = JSON.stringify(items);
		const encoded_item_id_1 = encodeURIComponent(jsonData1);

		items = {};
		for (let i = 1; i <= 3; i++) {
			const item_stat_1 = document.getElementById("item_"+i+"_stat_1_id_2").value;
			const item_stat_2 = document.getElementById("item_"+i+"_stat_2_id_2").value;
			const item_selected = document.getElementById("item_"+i+"_id_2").dataset.type;
			items[`item_id_${i}`] = [item_selected, item_stat_1, item_stat_2];
		}
		const jsonData2 = JSON.stringify(items);
		const encoded_item_id_2 = encodeURIComponent(jsonData2);


		let response = await fetch("mysqli/dmg_calc.php?attackant=" + perso_attackant + "&defenceur=" + perso_defenceur + "&attack_type=" + attack_type+ "&dmg=" + dmg_attackant+ "&hp=" + hp_defenceur+ "&armor=" + armor_defenceur+ "&itemsattaquant=" + encoded_item_id_1 + "&itemsdefenceur=" + encoded_item_id_2 + "&buffs=" + encodedBuffs);
		let data = await response.json();


		// Create a popup for the battle result
		const popup = document.createElement("div");
		popup.classList.add("battle-popup");
	
		data.forEach((round, i) => {
			const roundDiv = document.createElement("div");
			roundDiv.classList.add("battle-round");

			const title = document.createElement("div");
			title.classList.add("battle-round-title");
			title.textContent = `${round.nbr_of_crit} crit and ${round.nbr_of_block} block it has ${(round.proba*100).toFixed(2)}% chance to happen`;
			roundDiv.appendChild(title);

			const hpBarContainer = document.createElement("div");
			hpBarContainer.classList.add("hp-bar-container");

			const greenBar = document.createElement("div");
			greenBar.classList.add("hp-bar", "green");
			const yellowBar = document.createElement("div");
			yellowBar.classList.add("hp-bar", "yellow");
			const redBar = document.createElement("div");
			redBar.classList.add("hp-bar", "red");

			redBar.setAttribute("data-bs-toggle", "tooltip");
			redBar.setAttribute("data-bs-placement", "top");
			redBar.setAttribute("title", "remaining HP for minimal dmg : " + round.hp_min_dmg + "/" + round.start_hp + "hp");

			yellowBar.setAttribute("data-bs-toggle", "tooltip");
			yellowBar.setAttribute("data-bs-placement", "top");
			yellowBar.setAttribute("title", "remaining HP for medium dmg : " + round.hp_med_dmg + "/" + round.start_hp + "hp");

			greenBar.setAttribute("data-bs-toggle", "tooltip");
			greenBar.setAttribute("data-bs-placement", "top");
			greenBar.setAttribute("title",  "remaining HP for maximum dmg : " + round.hp_max_dmg + "/" + round.start_hp + "hp");

			hpBarContainer.appendChild(greenBar);
			hpBarContainer.appendChild(yellowBar);
			hpBarContainer.appendChild(redBar);

			greenBar.style.width = round.affichage_hp_min_dmg+"%";
			yellowBar.style.width = round.affichage_hp_med_dmg+"%";
			redBar.style.width = round.affichage_hp_max_dmg+"%";

	
			// hpBar.style.width = `${(round.remain_hp / round.start_hp) * 100}%`;


			roundDiv.appendChild(hpBarContainer);
			popup.appendChild(roundDiv);
		});



		// Close button
		const closeBtn = document.createElement("button");
		closeBtn.textContent = "Close";
		closeBtn.classList.add("battle-close-btn");
		closeBtn.onclick = () => popup.remove();
		popup.appendChild(closeBtn);

		document.body.appendChild(popup);
		const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
		const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
	}
	
	function selectbuff(buff_id) {
		const buff_img = document.getElementById("buff_img_"+buff_id);
		if (buff_img.dataset.selected == 0) {
			buff_img.dataset.selected = 1;
			buff_img.classList.remove("greyed");
		} else {
			buff_img.dataset.selected = 0;
			buff_img.classList.add("greyed");
		}
	}

	document.querySelectorAll(".custom-select").forEach(select => {
		const selected = select.querySelector(".selected");
		const options = select.querySelector(".options");

		// Toggle dropdown
		selected.addEventListener("click", () => {
			options.classList.toggle("hidden");
		});

		// Handle option click
		options.querySelectorAll("div").forEach(option => {
			option.addEventListener("click", () => {
			selected.innerHTML = option.innerHTML; // Replace selected with chosen option
			selected.dataset.value = option.dataset.value;
			options.classList.add("hidden");
			});
		});

		// Close if clicked outside
		document.addEventListener("click", (e) => {
			if (!select.contains(e.target)) {
			options.classList.add("hidden");
			}
		});
	});
	showbuffstart();
	document.getElementById("icon_1").addEventListener("click", loadMenuOptions(1));
	document.getElementById("icon_2").addEventListener("click", loadMenuOptions(2));

	// const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
	// const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

</script>

</body>
</html>