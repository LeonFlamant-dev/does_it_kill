<!-- TODO 
	tooltip on hover
	items fix perso qui vas vers le bas
	barre de vie
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>taticus does it kill</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
	body, html {
		height: 100%;
		margin: 0;
	}
	.main-container {
		display: flex;
		flex-direction: column;
		height: 100%;
	}
	.content {
		flex: 1;
	}
	.top-buttons {
		flex: 0 0 auto;
		display: flex;
		justify-content: center;
		gap: 20px;		background: #f8f9fa;
		border-bottom: 1px solid #ccc;
	}
	.bottom-bar {
		position: absolute;
		left: 0;
		right: 0;
		bottom: 0;
		height: 40px;
		gap: 10px;
		background: #f8f9fa;
		border: 1px solid #ccc;
		display: flex;
		align-items: center;
		justify-content: flex-end;
	}
	.center-area {
		flex: 1 1 auto;
		position: relative;  
		background: #eee;
		/* background: url("img/background.jpg") no-repeat center center;
		background-size: cover; */
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.center-area h1 {
		color: #333;
	}
	.clickable-img {
		position: absolute;
		width: 120px;
		height: auto;
		cursor: pointer;
		transition: transform 0.2s;
	}
	.clickable-img:hover {
		transform: scale(1.05);
	}
	.bottom-left {
		bottom: 80px;
		left: 135px;
	}
	.bottom-left-panel {
		bottom: 50px;
		left: 260px;
	}
	.bottom-left-menu-perso {
		display:none;
		position:absolute;
		bottom:270px;
		left:20px;
		background:white;
		border:1px solid #ccc;
		padding:5px;
		border-radius:5px;
	}
	.bottom-left-menu-palier {
		display:none; 
		position:absolute; 
		bottom:50px; 
		left:10px; 
		background:white; 
		border:1px solid #ccc; 
		padding:5px; 
		border-radius:5px;
	}
	.top-right-menu-perso {
		display:none;
		position:absolute;
		top:230px;
		right:20px;
		background:white;
		border:1px solid #ccc;
		padding:5px;
		border-radius:5px;
	}
	.top-right-menu-palier {
		display:none; 
		position:absolute; 
		top:10px; 
		right:10px; 
		background:white; 
		border:1px solid #ccc; 
		padding:5px; 
		border-radius:5px;
	}
	.top-right {
		top: 40px;
		right: 135px;
	}
	.top-right-panel {
		top: 10px;
		right: 260px;
	}

	/* Stats panel */
	.stats-panel {
		position: absolute;
		width: 280px;
		padding: 15px;
		background: rgb(255, 255, 255);
		border-left: 1px solid #ccc;
		box-shadow: -2px 0 6px rgba(0,0,0,0.1);
		display: none;
	}
	.stats-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	.panel-icon {
		height: 30px;
	}
	.stats-line {
		margin: 5px 0;
		color: #000000;
		font-weight: bold;
	}
	.stats-images {
		margin-top: 15px;
	}
	.stat-with-number {
		display: flex;
		align-items: center;
		margin-bottom: 10px;
	}
	.stat-with-number img {
		width: 50px;
		margin-right: 10px;
	}
	.stat-number {
		font-size: 18px;
		font-weight: bold;
		color: #007bff;
	}
	.stats-images img {
		width: 50px;
		margin-right: 10px;
	}
	.dropdown {
		border: 1px solid #ccc;
		border-radius: 5px;
		max-width: 200px;
		background: white;
	}

	.dropdown-item {
		padding: 5px;
		cursor: pointer;
	}

	.dropdown-item:hover {
		background: #f0f0f0;
	}
	.btn {
		display: flex;
		align-items: center;
		gap: 6px;
	}

	.btn-icon {
		width: 16px;
		height: 16px;
	}
	.custom-select {
		position: relative;
		width: 70px;
		cursor: pointer;
		user-select: none;
		font-family: sans-serif;
	}

	.custom-select .selected {
		padding: 5px;
		border: 1px solid #aaa;
		border-radius: 6px;
		background: #fff;
		display: flex;
		align-items: center;
		gap: 6px;
	}

	.custom-select .options {
		position: absolute;
		top: 110%;
		left: 0;
		right: 0;
		border: 1px solid #aaa;
		border-radius: 6px;
		background: #fff;
		box-shadow: 0 2px 6px rgba(0,0,0,0.15);
		z-index: 10;
	}

	.custom-select .options div {
		padding: 5px 10px;
		display: flex;
		align-items: center;
		gap: 6px;
	}

	.custom-select .options div:hover {
		background: #eee;
	}

	.hidden {
		display: none;
	}

</style>
</head>
<body>

<div class="main-container">
	
	<!-- Top Buttons -->
	<div class="top-buttons">
		<button class="btn btn-primary">Button 1</button>
		<button class="btn btn-success">Button 2</button>
		<button class="btn btn-danger">Button 3</button>
	</div>

	<!-- Center Area -->
	<div class="center-area">
		<h1>Main Content Area</h1>


<!-- <button type="button" class="btn btn-secondary" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></button> -->
		
			<img id="icon_1" src="img/perso/noperso/icon.png" alt="Left Image" class="clickable-img bottom-left"  onclick="showDropdown(1)" 
			data-bs-toggle="tooltip" 
			data-bs-placement="top" 
			title="">


		<!-- Menu déroulant selection perso (caché par défaut) -->
		<div id="dropdownMenu_perso_1" class="bottom-left-menu-perso">
		<select id="menuSelect_perso_1" onchange="showStats(1)">
			<option value="">-- Choisir un personnage --</option>
		</select>
		</div>

		<!-- Menu déroulant selection palier (caché par défaut) -->
		<div id="dropdownMenu_palier_1" class="bottom-left-menu-palier">
		<input type="hidden" id="palierValue_1">
		<div id="menuSelect_palier_1"></div>
		</div>

		<!-- Stats panel -->
		<div id="statsPanel_1" class="stats-panel bottom-left-panel">
			<div class="stats-row">
				<div class="stats-line" id="hp_id_1">0</div>
				<img id="palier_img_1" alt="icon" class="panel-icon">
			</div>
			<div class="stats-row">
				<div class="stats-line" id="armor_id_1">0</div>
				<div id="trait_container_1">
				</div>
			</div>
			<div class="stats-line" id="dmg_id_1">0</div>

			<!-- attack stats -->
			<div class="stats-images">
			<div class="stat-with-number">
				<img src="img/stat/mele.png" alt="mele" style="height:30px; width:30px; vertical-align:middle;">
				<img id="attack_mele_img_1" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="Small 1">
				<span id="attack_mele_nbr_1" class="stat-number">0</span>
			</div>
			<div class="stat-with-number" id ="attack_range_div_1">
				<img src="img/stat/range.png" alt="range" style="height:30px; width:30px; vertical-align:middle;">
				<img id="attack_range_img_1"data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="Small 1">
				<span id="attack_range_nbr_1" class="stat-number">0</span>
			</div>
			<div>
				<img id="active_img_1" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="active">
				<img id="passive_img_1" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="passive">
			</div>
			<div class="stats-row">
				<!-- items select -->
				<div class="custom-select" id="item_1_select_1">
					<div class="selected">
						<img src="img/item/crit_empty.png" >
					</div>
					<div id="item1_id_1" class="options hidden">
						<!-- <div data-value="empty"><img src="img/item/crit_empty.png" ></div> 
						<div data-value="bolt_pistol"><img src="img/item/blot_pistol.png" ></div> -->
					</div>
				</div>
				<div class="custom-select" id="item_2_select_1">
					<div class="selected">
						<img src="img/item/defensive_empty.png" >
					</div>
					<div id="item2_id_1" class="options hidden"></div>
				</div>
				<div class="custom-select" id="item_3_select_1">
					<div class="selected">
						<img src="img/item/crit_boost_empty.png" >
					</div>
					<div id="item3_id_1" class="options hidden"></div>
				</div>
			</div>
			</div>
		</div>




		<!-- Top-right image named 2 -->
		<img id="icon_2" src="img/perso/noperso/icon.png" alt="right Image" class="clickable-img top-right" onclick="showDropdown(2)">

		<!-- Menu déroulant selection perso 2 -->
		<div id="dropdownMenu_perso_2" class="top-right-menu-perso">
		<select id="menuSelect_perso_2" onchange="showStats(2)">
			<option value="">-- Choisir un personnage --</option>
		</select>
		</div>

		<!-- Menu déroulant selection palier (caché par défaut) -->
		<div id="dropdownMenu_palier_2" class="top-right-menu-palier">
		<input type="hidden" id="palierValue_2">
		<div id="menuSelect_palier_2"></div>
		</div>

		<!-- Stats panel -->
		<div id="statsPanel_2" class="stats-panel top-right-panel">
			<div class="stats-row">
				<div class="stats-line" id="hp_id_2">0</div>
				<img id="palier_img_2" alt="icon" class="panel-icon">
			</div>
			<div class="stats-row">
				<div class="stats-line" id="armor_id_2">0</div>
				<div id="trait_container_2">
				</div>
			</div>
			<div class="stats-line" id="dmg_id_2">0</div>

			<!-- attack stats -->
			<div class="stats-images">
			<div class="stat-with-number">
				<img src="img/stat/mele.png" alt="mele" style="height:30px; width:30px; vertical-align:middle;">
				<img id="attack_mele_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title=""  alt="Small 1">
				<span id="attack_mele_nbr_2" class="stat-number">0</span>
			</div>
			<div class="stat-with-number" id ="attack_range_div_2">
				<img src="img/stat/range.png" alt="range" style="height:30px; width:30px; vertical-align:middle;">
				<img id="attack_range_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="Small 1" >
				<span id="attack_range_nbr_2" class="stat-number">0</span>
			</div>
			<div>
				<img id="active_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="active">
				<img id="passive_img_2" data-bs-toggle="tooltip" data-bs-placement="top" title="" alt="passive">
			</div>
			<div class="stats-row">
				<!-- items select -->
				<div class="custom-select" id="item_1_select_2">
					<div class="selected">
						<img src="img/item/crit_empty.png" >
					</div>
					<div id="item1_id_2" class="options hidden">
						<!-- <div data-value="empty"><img src="img/item/crit_empty.png" ></div> 
						<div data-value="bolt_pistol"><img src="img/item/blot_pistol.png" ></div> -->
					</div>
				</div>
				<div class="custom-select" id="item_2_select_2">
					<div class="selected">
						<img src="img/item/defensive_empty.png" >
					</div>
					<div id="item2_id_2" class="options hidden"></div>
				</div>
				<div class="custom-select" id="item_3_select_2">
					<div class="selected">
						<img src="img/item/crit_boost_empty.png" >
					</div>
					<div id="item3_id_2" class="options hidden"></div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="bottom-bar">
		<!-- fill so button are on the right -->
		<button class="btn btn-primary" onclick=calcule_dmg(1)>
			<img src="img/stat/mele.png" alt="" class="btn-icon" > attack
		</button>
		<button class="btn btn-success" id="btn_range"  onclick=calcule_dmg(2)>
			<img  src="img/stat/range.png" alt="" class="btn-icon"> attack
		</button>
		<button class="btn btn-danger"  onclick=calcule_dmg(3)>
			<img id="btn_active_id" alt="" class="btn-icon"> active
		</button>
	</div>

</div>

<script>

	async function loadMenuOptions(img_id) {
		// menu perso
		let response_perso = await fetch("mysqli/get_perso.php");
		let perso = await response_perso.json();

		let select_perso = document.getElementById("menuSelect_perso_"+img_id);
		select_perso.innerHTML = '<option value="">-- Choisir un personnage --</option>';

		perso.forEach(c => {
			let option = document.createElement("option");
			option.value = c.nom;
			option.textContent = c.prettyname;
			select_perso.appendChild(option);
		});

		// menu palier
		let response_palier = await fetch("mysqli/get_palier.php");
		let palier = await response_palier.json();

		let select_palier = document.getElementById("menuSelect_palier_"+img_id);
		select_palier.innerHTML = '';

		palier.forEach(c => {
			let item = document.createElement("div");
			item.classList.add("dropdown-item");
			item.innerHTML = `<img src="img/palier/${c.palier}.png" style="height:16px; margin-right:5px;"> ${c.palier}`;
			
			item.onclick = () => {
				// console.log("Selected:", c.palier);
				document.getElementById("palierValue_"+img_id).value  = c.palier;
				showStats(img_id);
			};

			select_palier.appendChild(item);
		});
	}

	

	function showDropdown(img_id) {
		document.getElementById("dropdownMenu_perso_"+img_id).style.display = "none";
		document.getElementById("dropdownMenu_perso_"+img_id).style.display = "block";

		document.getElementById("dropdownMenu_palier_"+img_id).style.display = "none";
		document.getElementById("dropdownMenu_palier_"+img_id).style.display = "block";
	}

	async function showStats(img_id) {
		const perso_nom = document.getElementById("menuSelect_perso_"+img_id).value;
		const palier_nom = document.getElementById("palierValue_"+img_id).value;
		// console.log("Perso:", perso_nom, "Palier:", palier_nom);
		if (perso_nom && palier_nom) {

			let response = await fetch("mysqli/get_perso_stat.php?nom=" + perso_nom+"&palier=" + palier_nom);
			let data = await response.json();
			// console.log(data);

			// afficher le panel et cacher les dropdowns
			document.getElementById("statsPanel_"+img_id).style.display = "block";
			// document.getElementById("dropdownMenu_perso"+img_id).style.display = "none";
			// document.getElementById("dropdownMenu_palier"+img_id).style.display = "none";

			// images
			// icon
			document.getElementById("icon_"+img_id).src = "img/perso/" + data.nom + "/icon.png";
			// active et passive
			document.getElementById("active_img_"+img_id).src = "img/perso/" + data.nom + "/active.png";
			document.getElementById("passive_img_"+img_id).src = "img/perso/" + data.nom + "/passive.png";
			document.getElementById("active_img_"+img_id).title = data.active_description;
			document.getElementById("passive_img_"+img_id).title = data.passive_description;
			// attaques
			// si nbr_hit_range = 0 alors on n'affiche pas l'attaque
			if(data.nbr_hit_range != 0){
				document.getElementById("attack_range_div_"+img_id).style.display = "block";
				document.getElementById("attack_range_img_"+img_id).src = "img/perfo/" + data.perfo_range + ".png";
				document.getElementById("attack_range_img_"+img_id).title = data.perfo_range_description;
				document.getElementById("attack_range_nbr_"+img_id).innerText = data.nbr_hit_range;
				if(img_id == 1){
					document.getElementById("btn_range").disabled = false;
				}
			}
			else{
				if(img_id == 1){
					document.getElementById("btn_range").disabled = true;
				}
				
				document.getElementById("attack_range_div_"+img_id).style.display = "none";
			}
			document.getElementById("attack_mele_img_"+img_id).src = "img/perfo/" + data.perfo_mele + ".png";
			document.getElementById("attack_mele_img_"+img_id).title = data.perfo_mele_description;
			document.getElementById("attack_mele_nbr_"+img_id).innerText = data.nbr_hit_mele;

			document.getElementById("palier_img_"+img_id).src = "img/palier/" + palier_nom + ".png";

			//active btn img
			if(img_id == 1)
			{
				document.getElementById("btn_active_id").src = "img/perso/" + data.nom + "/active.png";
			}

			// stats
			document.getElementById("hp_id_"+img_id).innerHTML = '<img src="img/stat/hp_noir.png" alt="hp" style="height:20px; vertical-align:middle;"> '+
			`<input type="number" id="hp_input_${img_id}" value="${data.hp}" style="width:70px;">`;
			document.getElementById("armor_id_"+img_id).innerHTML = '<img src="img/stat/armor_noir.png" alt="armor" style="height:20px; vertical-align:middle;"> '+ 
			`<input type="number" id="armor_input_${img_id}" value="${data.armor}" style="width:70px;">`;
			document.getElementById("dmg_id_"+img_id).innerHTML = '<img src="img/stat/dmg_noir.png" alt="dmg" style="height:20px; vertical-align:middle;"> '+ 
			`<input type="number" id="dmg_input_${img_id}" value="${data.dmg}" style="width:70px;">`;


			// afficher traits
			const trait_container = document.getElementById("trait_container_"+img_id);
			trait_container.innerHTML = ''; // clear previous traits
			let traitsArray = JSON.parse(data.traits);
			for (const nom_trait of traitsArray) {
				let response_trait = await fetch("mysqli/get_trait_description.php?trait=" + nom_trait);
				let data_trait = await response_trait.json();
				console.log(data_trait.description);
				trait_container.innerHTML += `<img src="img/trait/${nom_trait}.png" alt="${nom_trait}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="${data_trait.description}" style="height:20px; margin-right:5px;">`;
			}

			//afficher items
			// data.item1 data.item2 data.item3
			for (let index = 1; index <= 3; index++) {
				let response_item = await fetch("mysqli/get_item_stat.php?nom=" + perso_nom+"&palier=" + palier_nom +"&item_nbr=item"+index);
				let data_item = await response_item.json();
				console.log(data_item);
				const item_container = document.getElementById("item"+index+"_id_"+img_id);
				item_container.innerHTML = '<div data-value="empty"><img src="img/item/'+data[`item${index}`]+'_empty.png" data-bs-toggle="tooltip" data-bs-placement="right" title="no Item" ></div>';
				data_item.forEach(c => {
					item_container.innerHTML += `<div data-value="${c.nom}"><img src="img/item/${c.nom}.png" data-bs-toggle="tooltip" data-bs-placement="right" title="${c.prettyname}""> </div>`;
				});
				item_container.querySelectorAll("div").forEach(option => {
					option.addEventListener("click", () => {
						const selected = document.querySelector(`#item_${index}_select_${img_id} .selected`);
						selected.innerHTML = option.innerHTML;
						selected.dataset.value = option.dataset.value;
						item_container.classList.add("hidden");
					});
				});
			}

		}
		const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
		const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
	}

	async function calcule_dmg(attack_type) {
		// attack_type: 1 = mele, 2 = range, 3 = active
		const perso_attackant = document.getElementById("menuSelect_perso_1").value;
		const dmg_attackant = document.getElementById("dmg_input_1").value;
		const perso_defenceur = document.getElementById("menuSelect_perso_2").value;
		const hp_defenceur = document.getElementById("hp_input_").value; // for now 1 always attack and 2 always defence (tochange later)
		const armor_defenceur = document.getElementById("armor_input_2").value
		// need to have perso and dmg attackant and perso,hp,armor defenceur
		if (perso_attackant && perso_defenceur) {
			// let response = await fetch("mysqli/calc_dmg.php?attackant=" + perso_attackant + "&defenceur=" + perso_defenceur + "&attack_type=" + attack_type+ "&dmg=" + dmg_attackant+ "&hp=" + hp_defenceur+ "&armor=" + armor_defenceur);
			// let data = await response.json();
			alert("Damage calculated: " + dmg_attackant);
			// alert("This feature is under development.");


			// todo afficher le resultat dans une popup en iterant sur data avec une barre de vie pour chaque iteration 
		} else {
			alert("Please select a character and tier first.");
		}
	}
	
	document.querySelectorAll(".custom-select").forEach(select => {
		const selected = select.querySelector(".selected");
		const options = select.querySelector(".options");

		// Toggle dropdown
		selected.addEventListener("click", () => {
			options.classList.toggle("hidden");
		});

		// Handle option click
		options.querySelectorAll("div").forEach(option => {
			option.addEventListener("click", () => {
			selected.innerHTML = option.innerHTML; // Replace selected with chosen option
			selected.dataset.value = option.dataset.value;
			options.classList.add("hidden");
			});
		});

		// Close if clicked outside
		document.addEventListener("click", (e) => {
			if (!select.contains(e.target)) {
			options.classList.add("hidden");
			}
		});
	});

	document.getElementById("icon_1").addEventListener("click", loadMenuOptions(1));
	document.getElementById("icon_2").addEventListener("click", loadMenuOptions(2));

	const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
	const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

</script>

</body>
</html>